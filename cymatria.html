<!doctype html>
<html lang="en">
  <head>
    <title>Cymatria - S..A.:</title>
    <meta charset="utf-8">
    <script src="/assets/js/three.min.js"></script>
    <script src="/assets/js/libs.min.js"></script>
    <script src="/assets/js/dat.gui.min.js"></script>
    <script type="x-shader/x-vertex" id="testFragShader">
    uniform sampler2D t_pos;
    uniform sampler2D t_oPos;
    uniform vec2 resolution;
    void main(){
      vec2 uv = gl_FragCoord.xy / resolution;
      vec4 oPos = texture2D(t_oPos, uv);
      vec4 pos = texture2D(t_pos, uv);
      vec3 vel = pos.xyz - oPos.xyz;
      vec3 force = vec3(0., -1., 0.);
      vel += force;
      vec3 newPos = pos.xyz + vel;
      gl_FragColor = vec4(newPos, 1.);
    }
    </script>
    <script type="x-shader/x-vertex" id="simFragShader">
uniform sampler2D t_pos;
uniform sampler2D t_oPos;
uniform vec2 resolution;
uniform float time;
uniform float rM;
uniform float thetaM;
uniform float phiM;
uniform float scale;
uniform float fft[128];
uniform float baseFreq;
uniform float freqM;
uniform float bounds;

highp float rand(vec2 co) {
  highp float a = 12.9898;
  highp float b = 78.233;
  highp float c = 43758.5453;
  highp float dt = dot(co.xy, vec2(a,b));
  highp float sn = mod(dt, 3.14);
  return fract(sin(sn) * c);
}

void main(){
 //lookup current(previous) position
 vec2 uv = gl_FragCoord.xy / resolution;
 vec3 oldPos = texture2D(t_oPos, uv).xyz;
 vec3 pos = texture2D(t_pos, uv).xyz;
 vec3 vel = pos - oldPos;
 vec3 force = vec3(0., 0., -0.5);
 float currFreq = baseFreq;
 //perturb particles at each FFT frequency
 //if(dot(pos,pos) > 0.001){
   for(int i = 0; i < 128; i++){
      //move particle here
      float r = rM * sqrt(dot(pos,pos));
      float theta = thetaM * acos(pos.z / r);
      float phi = phiM * atan(pos.y, pos.x);
      force.x = force.x + (fft[i]*scale*(cos(phi*currFreq)*sin(theta))*sin(r-currFreq*time));
      force.y = force.y + (fft[i]*scale*(sin(phi*currFreq)*sin(theta))*sin(r-currFreq*time));
      force.z = force.z + (fft[i]*(scale/4.0)*cos(theta)*sin(r-currFreq*time)/r);
      force.z = min(15., force.z);
      currFreq = currFreq*freqM;
   }
   pos = pos + force + (vel * 0.35);
   pos.z = max(pos.z, 0.);
 //}
 //respawn if over bounds
 if(abs(pos.x) > bounds){
   pos.x = 2. * bounds * (rand(vec2(pos.x, pos.y + pos.z))-.5);
   pos.y = 2. * bounds * (rand(vec2(pos.y, pos.x + pos.z))-.5);
 } else if (abs(pos.y) > bounds) {
   pos.x = 2. * bounds * (rand(vec2(pos.x, pos.y + pos.z))-.5);
   pos.y = 2. * bounds * (rand(vec2(pos.y, pos.x + pos.z))-.5); 
 }
 gl_FragColor = vec4(pos.xyz, 1.0);
}
    </script>
    <script type="x-shader/x-vertex" id="renderVertexShader">
uniform sampler2D t_pos;
void main(){
  vec4 pos = texture2D(t_pos, position.xy);
  vec3 dif = cameraPosition - pos.xyz;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos.xyz, 1.0);
  gl_PointSize = min(5., 50. / length(dif));
}
    </script>
    <script type="x-shader/x-vertex" id="renderFragShader">
void main(){
  gl_FragColor = vec4(1.);
}
    </script>

    <script src="/assets/js/cymatria.min.js"></script>
  </head>

  <body>
    <div id="container"></div>
    <audio id="audio" loop="true">
       <source src="/assets/audio/sample.mp3" type="audio/mpeg">
       Loading error. Your browser does not support the audio element.
    </audio>
    <input id="fileInput" type="file" accept="audio/*" hidden=true>
  </body>

</html>
