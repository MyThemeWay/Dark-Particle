function onWindowResize(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()}function generateLookupGeometry(e){for(var n=new THREE.BufferGeometry,r=new Float32Array(e*e*3),a=0,t=0;a<e*e;a++,t+=3)r[t]=a%e/e,r[t+1]=Math.floor(a/e)/e;var i=new THREE.BufferAttribute(r,3);return n.addAttribute("position",i),n}function generateRandomPlane(e,n,r){for(var a=e*e*4,t=new Float32Array(a),i=0;i<e;i++)for(var o=0;o<e;o++)t[4*(i*e+o)]=(i-e/2+Math.random())/(e/r),t[4*(i*e+o)+1]=(o-e/2+Math.random())/(e/r),t[4*(i*e+o)+2]=Math.random()*n,t[4*(i*e+o)+3]=0;return t}function render(){requestAnimationFrame(render),analyser.getFloatTimeDomainData(freqArr),simUniforms.fft.value=freqArr,simUniforms.time.value=freq*(Date.now()-start),physicsRenderer.update(),renderer.render(scene,camera)}var renderer,physicsRenderer,scene,camera,analyser,freqArr,start=Date.now(),fov=75,SIZE=512,freq=.005,scale=64,simUniforms={time:{type:"f",value:0},rM:{type:"f",value:1},phiM:{type:"f",value:5},thetaM:{type:"f",value:7},scale:{type:"f",value:.7},baseFreq:{type:"f",value:1},freqM:{type:"f",value:1.0025},bounds:{type:"f",value:(SIZE-SIZE/2)/(SIZE/scale)},fft:{type:"1fv",value:null}},uniforms={t_pos:{type:"t",value:null}};window.addEventListener("load",function(){var e=document.getElementById("container");scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(fov,window.innerWidth/window.innerHeight,1,1e3),camera.position.z=100;var n=new(window.AudioContext||window.webkitAudioContext),r=document.getElementById("audio"),a=n.createMediaElementSource(r);analyser=n.createAnalyser(),analyser.minDecibels=-90,analyser.maxDecibels=-10,analyser.smoothingTimeConstant=.85,analyser.fftSize=256,a.connect(analyser),a.connect(n.destination),r.play(),freqArr=new Float32Array(analyser.frequencyBinCount),analyser.getFloatTimeDomainData(freqArr),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(window.devicePixelRatio),e.appendChild(renderer.domElement);var t=document.getElementById("simFragShader").textContent;physicsRenderer=new PhysicsRenderer(SIZE,t,renderer),physicsRenderer.setUniforms(simUniforms);var i=generateLookupGeometry(SIZE),o=document.getElementById("renderVertexShader").textContent,s=document.getElementById("renderFragShader").textContent;renderMaterial=new THREE.ShaderMaterial({uniforms:uniforms,vertexShader:o,fragmentShader:s});var d=new THREE.Points(i,renderMaterial);d.frustumCulled=!1,scene.add(d);var l=generateRandomPlane(SIZE,.5,scale),m=new THREE.DataTexture(l,SIZE,SIZE,THREE.RGBAFormat,THREE.FloatType);m.minFilter=THREE.NearestFilter,m.magFilter=THREE.NearestFilter,m.needsUpdate=!0,physicsRenderer.reset(m),physicsRenderer.addBoundTexture(uniforms.t_pos,"output");var u=(new THREE.OrbitControls(camera,renderer.domElement),new dat.GUI),f=u.addFolder("Wave Parameters"),c={Radius:simUniforms.rM.value,Phi:simUniforms.phiM.value,Theta:simUniforms.thetaM.value,baseFreq:simUniforms.baseFreq.value,freqScale:simUniforms.freqM.value,Amplitude:simUniforms.scale.value,Frequency:freq};f.add(c,"Radius",.25,5).onFinishChange(function(e){simUniforms.rM.value=e}),f.add(c,"Phi",.1,50).onFinishChange(function(e){simUniforms.phiM.value=e}),f.add(c,"Theta",.1,50).onFinishChange(function(e){simUniforms.thetaM.value=e}),f.add(c,"baseFreq",.01,5).onFinishChange(function(e){simUniforms.baseFreq.value=e}),f.add(c,"freqScale",1.0001,1.01).onFinishChange(function(e){simUniforms.freqM.value=e}),f.add(c,"Amplitude",.1,5).onFinishChange(function(e){simUniforms.scale.value=e}),f.add(c,"Frequency",.001,.01).onFinishChange(function(e){freq=e});var h={reset:function(){physicsRenderer.reset(m)}};f.add(h,"reset"),f.open();var v=u.addFolder("Music Controls"),y=document.getElementById("fileInput"),p={file:function(){y.click()}};v.add(p,"file"),y.onchange=function(){var e=this.files,n=URL.createObjectURL(e[0]);r.src=n,r.play()};var w={play:function(){r.play()}};v.add(w,"play");var E={stop:function(){r.pause()}};v.add(E,"stop"),v.open(),onWindowResize(),window.addEventListener("resize",onWindowResize),render()});