function PhysicsRenderer(e,t,n){this.checkCompatibility(n),this.renderer=n,this.size=e||128,this.s2=e*e,this.renderer=n,this.clock=new THREE.Clock,this.resolution=new THREE.Vector2(this.size,this.size),this.rt_1=new THREE.WebGLRenderTarget(this.size,this.size,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType,stencilBuffer:!1}),this.rt_2=this.rt_1.clone(),this.rt_3=this.rt_1.clone(),this.counter=0,this.debugScene=this.createDebugScene(),this.texturePassProgram=this.createTexturePassProgram(),this.simulation=this.createSimulationProgram(t),this.material=this.simulation,this.boundTextures=[],this.camera=new THREE.OrthographicCamera(-.5,.5,.5,-.5,0,1),this.scene=new THREE.Scene,this.mesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(1,1)),this.scene.add(this.mesh)}THREE.OrbitControls=function(e,t){function n(){return 2*Math.PI/60/60*N.autoRotateSpeed}function o(){return Math.pow(.95,N.zoomSpeed)}function i(e){z.theta-=e}function r(e){z.phi-=e}function s(e){N.object instanceof THREE.PerspectiveCamera?Z/=e:N.object instanceof THREE.OrthographicCamera?(N.object.zoom=Math.max(N.minZoom,Math.min(N.maxZoom,N.object.zoom*e)),N.object.updateProjectionMatrix(),I=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),N.enableZoom=!1)}function a(e){N.object instanceof THREE.PerspectiveCamera?Z*=e:N.object instanceof THREE.OrthographicCamera?(N.object.zoom=Math.max(N.minZoom,Math.min(N.maxZoom,N.object.zoom/e)),N.object.updateProjectionMatrix(),I=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),N.enableZoom=!1)}function c(e){B.set(e.clientX,e.clientY)}function u(e){Q.set(e.clientX,e.clientY)}function h(e){K.set(e.clientX,e.clientY)}function l(e){X.set(e.clientX,e.clientY),G.subVectors(X,B);var t=N.domElement===document?N.domElement.body:N.domElement;i(2*Math.PI*G.x/t.clientWidth*N.rotateSpeed),r(2*Math.PI*G.y/t.clientHeight*N.rotateSpeed),B.copy(X),N.update()}function m(e){J.set(e.clientX,e.clientY),$.subVectors(J,Q),$.y>0?s(o()):$.y<0&&a(o()),Q.copy(J),N.update()}function d(e){W.set(e.clientX,e.clientY),q.subVectors(W,K),ne(q.x,q.y),K.copy(W),N.update()}function p(e){}function E(e){e.deltaY<0?a(o()):e.deltaY>0&&s(o()),N.update()}function b(e){switch(e.keyCode){case N.keys.UP:ne(0,N.keyPanSpeed),N.update();break;case N.keys.BOTTOM:ne(0,-N.keyPanSpeed),N.update();break;case N.keys.LEFT:ne(N.keyPanSpeed,0),N.update();break;case N.keys.RIGHT:ne(-N.keyPanSpeed,0),N.update()}}function f(e){B.set(e.touches[0].pageX,e.touches[0].pageY)}function R(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(t*t+n*n);Q.set(0,o)}function T(e){K.set(e.touches[0].pageX,e.touches[0].pageY)}function v(e){X.set(e.touches[0].pageX,e.touches[0].pageY),G.subVectors(X,B);var t=N.domElement===document?N.domElement.body:N.domElement;i(2*Math.PI*G.x/t.clientWidth*N.rotateSpeed),r(2*Math.PI*G.y/t.clientHeight*N.rotateSpeed),B.copy(X),N.update()}function y(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+n*n);J.set(0,i),$.subVectors(J,Q),$.y>0?a(o()):$.y<0&&s(o()),Q.copy(J),N.update()}function g(e){W.set(e.touches[0].pageX,e.touches[0].pageY),q.subVectors(W,K),ne(q.x,q.y),K.copy(W),N.update()}function P(e){}function H(e){if(!1!==N.enabled){if(e.preventDefault(),e.button===N.mouseButtons.ORBIT){if(!1===N.enableRotate)return;c(e),F=D.ROTATE}else if(e.button===N.mouseButtons.ZOOM){if(!1===N.enableZoom)return;u(e),F=D.DOLLY}else if(e.button===N.mouseButtons.PAN){if(!1===N.enablePan)return;h(e),F=D.PAN}F!==D.NONE&&(document.addEventListener("mousemove",O,!1),document.addEventListener("mouseup",w,!1),N.dispatchEvent(U))}}function O(e){if(!1!==N.enabled)if(e.preventDefault(),F===D.ROTATE){if(!1===N.enableRotate)return;l(e)}else if(F===D.DOLLY){if(!1===N.enableZoom)return;m(e)}else if(F===D.PAN){if(!1===N.enablePan)return;d(e)}}function w(e){!1!==N.enabled&&(p(e),document.removeEventListener("mousemove",O,!1),document.removeEventListener("mouseup",w,!1),N.dispatchEvent(L),F=D.NONE)}function x(e){!1===N.enabled||!1===N.enableZoom||F!==D.NONE&&F!==D.ROTATE||(e.preventDefault(),e.stopPropagation(),E(e),N.dispatchEvent(U),N.dispatchEvent(L))}function _(e){!1!==N.enabled&&!1!==N.enableKeys&&!1!==N.enablePan&&b(e)}function M(e){if(!1!==N.enabled){switch(e.touches.length){case 1:if(!1===N.enableRotate)return;f(e),F=D.TOUCH_ROTATE;break;case 2:if(!1===N.enableZoom)return;R(e),F=D.TOUCH_DOLLY;break;case 3:if(!1===N.enablePan)return;T(e),F=D.TOUCH_PAN;break;default:F=D.NONE}F!==D.NONE&&N.dispatchEvent(U)}}function j(e){if(!1!==N.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===N.enableRotate)return;if(F!==D.TOUCH_ROTATE)return;v(e);break;case 2:if(!1===N.enableZoom)return;if(F!==D.TOUCH_DOLLY)return;y(e);break;case 3:if(!1===N.enablePan)return;if(F!==D.TOUCH_PAN)return;g(e);break;default:F=D.NONE}}function S(e){!1!==N.enabled&&(P(e),N.dispatchEvent(L),F=D.NONE)}function C(e){e.preventDefault()}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return V.phi},this.getAzimuthalAngle=function(){return V.theta},this.reset=function(){N.target.copy(N.target0),N.object.position.copy(N.position0),N.object.zoom=N.zoom0,N.object.updateProjectionMatrix(),N.dispatchEvent(A),N.update(),F=D.NONE},this.update=function(){var t=new THREE.Vector3,o=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),r=o.clone().inverse(),s=new THREE.Vector3,a=new THREE.Quaternion;return function(){var e=N.object.position;return t.copy(e).sub(N.target),t.applyQuaternion(o),V.setFromVector3(t),N.autoRotate&&F===D.NONE&&i(n()),V.theta+=z.theta,V.phi+=z.phi,V.theta=Math.max(N.minAzimuthAngle,Math.min(N.maxAzimuthAngle,V.theta)),V.phi=Math.max(N.minPolarAngle,Math.min(N.maxPolarAngle,V.phi)),V.makeSafe(),V.radius*=Z,V.radius=Math.max(N.minDistance,Math.min(N.maxDistance,V.radius)),N.target.add(Y),t.setFromSpherical(V),t.applyQuaternion(r),e.copy(N.target).add(t),N.object.lookAt(N.target),!0===N.enableDamping?(z.theta*=1-N.dampingFactor,z.phi*=1-N.dampingFactor):z.set(0,0,0),Z=1,Y.set(0,0,0),!!(I||s.distanceToSquared(N.object.position)>k||8*(1-a.dot(N.object.quaternion))>k)&&(N.dispatchEvent(A),s.copy(N.object.position),a.copy(N.object.quaternion),I=!1,!0)}}(),this.dispose=function(){N.domElement.removeEventListener("contextmenu",C,!1),N.domElement.removeEventListener("mousedown",H,!1),N.domElement.removeEventListener("wheel",x,!1),N.domElement.removeEventListener("touchstart",M,!1),N.domElement.removeEventListener("touchend",S,!1),N.domElement.removeEventListener("touchmove",j,!1),document.removeEventListener("mousemove",O,!1),document.removeEventListener("mouseup",w,!1),window.removeEventListener("keydown",_,!1)};var N=this,A={type:"change"},U={type:"start"},L={type:"end"},D={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},F=D.NONE,k=1e-6,V=new THREE.Spherical,z=new THREE.Spherical,Z=1,Y=new THREE.Vector3,I=!1,B=new THREE.Vector2,X=new THREE.Vector2,G=new THREE.Vector2,K=new THREE.Vector2,W=new THREE.Vector2,q=new THREE.Vector2,Q=new THREE.Vector2,J=new THREE.Vector2,$=new THREE.Vector2,ee=function(){var e=new THREE.Vector3;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),Y.add(e)}}(),te=function(){var e=new THREE.Vector3;return function(t,n){e.setFromMatrixColumn(n,1),e.multiplyScalar(t),Y.add(e)}}(),ne=function(){var e=new THREE.Vector3;return function(t,n){var o=N.domElement===document?N.domElement.body:N.domElement;if(N.object instanceof THREE.PerspectiveCamera){var i=N.object.position;e.copy(i).sub(N.target);var r=e.length();r*=Math.tan(N.object.fov/2*Math.PI/180),ee(2*t*r/o.clientHeight,N.object.matrix),te(2*n*r/o.clientHeight,N.object.matrix)}else N.object instanceof THREE.OrthographicCamera?(ee(t*(N.object.right-N.object.left)/N.object.zoom/o.clientWidth,N.object.matrix),te(n*(N.object.top-N.object.bottom)/N.object.zoom/o.clientHeight,N.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),N.enablePan=!1)}}();N.domElement.addEventListener("contextmenu",C,!1),N.domElement.addEventListener("mousedown",H,!1),N.domElement.addEventListener("wheel",x,!1),N.domElement.addEventListener("touchstart",M,!1),N.domElement.addEventListener("touchend",S,!1),N.domElement.addEventListener("touchmove",j,!1),window.addEventListener("keydown",_,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}}),PhysicsRenderer.prototype.checkCompatibility=function(e){var t=e.context;return null===t.getExtension("OES_texture_float")?void this.onError("No Float Textures"):0===t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS)?void this.onError("Vert Shader Textures don't work"):void 0},PhysicsRenderer.prototype.onError=function(e){console.log(e)},PhysicsRenderer.prototype.createDebugScene=function(){var e=new THREE.Object3D;e.position.z=0;var t=new THREE.PlaneBufferGeometry(100,100),n=new THREE.Mesh(t,new THREE.MeshBasicMaterial({map:this.rt_1.texture}));n.position.set(-105,0,0),e.add(n);var n=new THREE.Mesh(t,new THREE.MeshBasicMaterial({map:this.rt_2.texture}));n.position.set(0,0,0),e.add(n);var n=new THREE.Mesh(t,new THREE.MeshBasicMaterial({map:this.rt_3.texture}));return n.position.set(105,0,0),e.add(n),e},PhysicsRenderer.prototype.removeDebugScene=function(e){e.remove(this.debugScene)},PhysicsRenderer.prototype.addDebugScene=function(e){e.add(this.debugScene)},PhysicsRenderer.prototype.createTexturePassProgram=function(){var e={texture:{type:"t",value:null}};return new THREE.ShaderMaterial({uniforms:e,vertexShader:this.VSPass,fragmentShader:this.FSPass})},PhysicsRenderer.prototype.createSimulationProgram=function(e){return this.simulationUniforms={t_oPos:{type:"t",value:null},t_pos:{type:"t",value:null},resolution:{type:"v2",value:this.resolution}},new THREE.ShaderMaterial({uniforms:this.simulationUniforms,vertexShader:this.VSPass,fragmentShader:e})},PhysicsRenderer.prototype.VSPass=["varying vec2 vUv;","void main() {","  vUv = uv;","  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),PhysicsRenderer.prototype.FSPass=["uniform sampler2D texture;","varying vec2 vUv;","void main() {","  vec4 c = texture2D( texture , vUv );","  gl_FragColor = c ;","}"].join("\n"),PhysicsRenderer.prototype.update=function(){var e=this.counter%3;0==e?(this.simulation.uniforms.t_oPos.value=this.rt_1.texture,this.simulation.uniforms.t_pos.value=this.rt_2.texture,this.pass(this.simulation,this.rt_3),this.ooOutput=this.rt_1,this.oOutput=this.rt_2,this.output=this.rt_3):1==e?(this.simulation.uniforms.t_oPos.value=this.rt_2.texture,this.simulation.uniforms.t_pos.value=this.rt_3.texture,this.pass(this.simulation,this.rt_1),this.ooOutput=this.rt_2,this.oOutput=this.rt_3,this.output=this.rt_1):2==e&&(this.simulation.uniforms.t_oPos.value=this.rt_3.texture,this.simulation.uniforms.t_pos.value=this.rt_1.texture,this.pass(this.simulation,this.rt_2),this.ooOutput=this.rt_3,this.oOutput=this.rt_1,this.output=this.rt_2),this.counter++,this.bindTextures()},PhysicsRenderer.prototype.render=function(e,t,n){renderer.render(e,t,n,!1)},PhysicsRenderer.prototype.pass=function(e,t){this.mesh.material=e,this.renderer.render(this.scene,this.camera,t,!1)},PhysicsRenderer.prototype.out=function(e){this.mesh.material=e.material,this.renderer.render(this.scene,this.camera)},PhysicsRenderer.prototype.setUniforms=function(e){for(var t in e)this.simulation.uniforms[t]=e[t];this.simulation.uniforms.t_pos={type:"t",value:null},this.simulation.uniforms.t_oPos={type:"t",value:null},this.simulation.uniforms.resolution={type:"v2",value:this.resolution},console.log(this.simulation.uniforms)},PhysicsRenderer.prototype.setUniform=function(e,t){this.simulation.uniforms[e]=t},PhysicsRenderer.prototype.reset=function(e){this.texture=e,this.texturePassProgram.uniforms.texture.value=e,this.pass(this.texturePassProgram,this.rt_1),this.pass(this.texturePassProgram,this.rt_2),this.pass(this.texturePassProgram,this.rt_3)},PhysicsRenderer.prototype.passTexture=function(e,t){this.texturePassProgram.uniforms.texture.value=e,this.pass(this.texturePassProgram,t)},PhysicsRenderer.prototype.resetRand=function(e,t){for(var e=e||100,n=new Float32Array(4*this.s2),o=0;o<n.length;o++)n[o]=(Math.random()-.5)*e,t&&o%4==3&&(n[o]=0);var i=new THREE.DataTexture(n,this.size,this.size,THREE.RGBAFormat,THREE.FloatType);i.minFilter=THREE.NearestFilter,i.magFilter=THREE.NearestFilter,i.needsUpdate=!0,this.reset(i)},PhysicsRenderer.prototype.addBoundTexture=function(e,t){this.boundTextures.push([e,t])},PhysicsRenderer.prototype.bindTextures=function(){for(var e=0;e<this.boundTextures.length;e++){var t=this.boundTextures[e][0],n=this.boundTextures[e][1];t.value=this[n].texture}};